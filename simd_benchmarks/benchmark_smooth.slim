// Benchmark script: smooth() vs smooth_fast()
// Compares performance of original smooth() and SIMD-optimized smooth_fast()
// Run with: ./slim simd_benchmarks/benchmark_smooth.slim

initialize() {
    initializeSLiMModelType("nonWF");
    initializeSLiMOptions(dimensionality="xyz");
}

1 early() {
    sim.addSubpop("p1", 10);
    p1.setSpatialBounds(c(0.0, 0.0, 0.0, 1.0, 1.0, 1.0));

    catn("===========================================");
    catn("Benchmark: smooth() vs smooth_fast()");
    catn("===========================================\n");

    // Number of iterations for timing
    defineConstant("ITERS", 10);

    //
    // 1D Benchmarks
    //
    catn("--- 1D Spatial Maps ---");

    // Small 1D: 100 points
    v1d_small = runif(100);
    map1d_s1 = p1.defineSpatialMap("bench1d_s1", "x", v1d_small, interpolate=F);
    map1d_s2 = p1.defineSpatialMap("bench1d_s2", "x", v1d_small, interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map1d_s1.changeValues(v1d_small);
        map1d_s1.smooth(0.1, "n", 0.03);
    }
    t2 = clock("mono");
    smooth_1d_small = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map1d_s2.changeValues(v1d_small);
        map1d_s2.smooth_fast(0.1, "n", 0.03);
    }
    t4 = clock("mono");
    smooth_fast_1d_small = (t4 - t3) / ITERS * 1000;

    catn("  100 points:  smooth=" + format("%.3f", smooth_1d_small) + "ms, smooth_fast=" + format("%.3f", smooth_fast_1d_small) + "ms, speedup=" + format("%.2f", smooth_1d_small/smooth_fast_1d_small) + "x");

    // Large 1D: 1000 points
    v1d_large = runif(1000);
    map1d_l1 = p1.defineSpatialMap("bench1d_l1", "x", v1d_large, interpolate=F);
    map1d_l2 = p1.defineSpatialMap("bench1d_l2", "x", v1d_large, interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map1d_l1.changeValues(v1d_large);
        map1d_l1.smooth(0.05, "n", 0.015);
    }
    t2 = clock("mono");
    smooth_1d_large = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map1d_l2.changeValues(v1d_large);
        map1d_l2.smooth_fast(0.05, "n", 0.015);
    }
    t4 = clock("mono");
    smooth_fast_1d_large = (t4 - t3) / ITERS * 1000;

    catn("  1000 points: smooth=" + format("%.3f", smooth_1d_large) + "ms, smooth_fast=" + format("%.3f", smooth_fast_1d_large) + "ms, speedup=" + format("%.2f", smooth_1d_large/smooth_fast_1d_large) + "x");

    //
    // 2D Benchmarks
    //
    catn("\n--- 2D Spatial Maps ---");

    // Small 2D: 50x50 = 2500 points
    v2d_small = runif(2500);
    map2d_s1 = p1.defineSpatialMap("bench2d_s1", "xy", matrix(v2d_small, 50, 50), interpolate=F);
    map2d_s2 = p1.defineSpatialMap("bench2d_s2", "xy", matrix(v2d_small, 50, 50), interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map2d_s1.changeValues(matrix(v2d_small, 50, 50));
        map2d_s1.smooth(0.1, "n", 0.03);
    }
    t2 = clock("mono");
    smooth_2d_small = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map2d_s2.changeValues(matrix(v2d_small, 50, 50));
        map2d_s2.smooth_fast(0.1, "n", 0.03);
    }
    t4 = clock("mono");
    smooth_fast_2d_small = (t4 - t3) / ITERS * 1000;

    catn("  50x50:   smooth=" + format("%.3f", smooth_2d_small) + "ms, smooth_fast=" + format("%.3f", smooth_fast_2d_small) + "ms, speedup=" + format("%.2f", smooth_2d_small/smooth_fast_2d_small) + "x");

    // Medium 2D: 100x100 = 10000 points
    v2d_med = runif(10000);
    map2d_m1 = p1.defineSpatialMap("bench2d_m1", "xy", matrix(v2d_med, 100, 100), interpolate=F);
    map2d_m2 = p1.defineSpatialMap("bench2d_m2", "xy", matrix(v2d_med, 100, 100), interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map2d_m1.changeValues(matrix(v2d_med, 100, 100));
        map2d_m1.smooth(0.1, "n", 0.025);
    }
    t2 = clock("mono");
    smooth_2d_med = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map2d_m2.changeValues(matrix(v2d_med, 100, 100));
        map2d_m2.smooth_fast(0.1, "n", 0.025);
    }
    t4 = clock("mono");
    smooth_fast_2d_med = (t4 - t3) / ITERS * 1000;

    catn("  100x100: smooth=" + format("%.3f", smooth_2d_med) + "ms, smooth_fast=" + format("%.3f", smooth_fast_2d_med) + "ms, speedup=" + format("%.2f", smooth_2d_med/smooth_fast_2d_med) + "x");

    // Large 2D: 200x200 = 40000 points
    v2d_large = runif(40000);
    map2d_l1 = p1.defineSpatialMap("bench2d_l1", "xy", matrix(v2d_large, 200, 200), interpolate=F);
    map2d_l2 = p1.defineSpatialMap("bench2d_l2", "xy", matrix(v2d_large, 200, 200), interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map2d_l1.changeValues(matrix(v2d_large, 200, 200));
        map2d_l1.smooth(0.1, "n", 0.02);
    }
    t2 = clock("mono");
    smooth_2d_large = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map2d_l2.changeValues(matrix(v2d_large, 200, 200));
        map2d_l2.smooth_fast(0.1, "n", 0.02);
    }
    t4 = clock("mono");
    smooth_fast_2d_large = (t4 - t3) / ITERS * 1000;

    catn("  200x200: smooth=" + format("%.3f", smooth_2d_large) + "ms, smooth_fast=" + format("%.3f", smooth_fast_2d_large) + "ms, speedup=" + format("%.2f", smooth_2d_large/smooth_fast_2d_large) + "x");

    //
    // 3D Benchmarks
    //
    catn("\n--- 3D Spatial Maps ---");

    // Small 3D: 20x20x20 = 8000 points
    v3d_small = runif(8000);
    map3d_s1 = p1.defineSpatialMap("bench3d_s1", "xyz", array(v3d_small, c(20, 20, 20)), interpolate=F);
    map3d_s2 = p1.defineSpatialMap("bench3d_s2", "xyz", array(v3d_small, c(20, 20, 20)), interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map3d_s1.changeValues(array(v3d_small, c(20, 20, 20)));
        map3d_s1.smooth(0.15, "n", 0.05);
    }
    t2 = clock("mono");
    smooth_3d_small = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map3d_s2.changeValues(array(v3d_small, c(20, 20, 20)));
        map3d_s2.smooth_fast(0.15, "n", 0.05);
    }
    t4 = clock("mono");
    smooth_fast_3d_small = (t4 - t3) / ITERS * 1000;

    catn("  20x20x20: smooth=" + format("%.3f", smooth_3d_small) + "ms, smooth_fast=" + format("%.3f", smooth_fast_3d_small) + "ms, speedup=" + format("%.2f", smooth_3d_small/smooth_fast_3d_small) + "x");

    // Medium 3D: 30x30x30 = 27000 points
    v3d_med = runif(27000);
    map3d_m1 = p1.defineSpatialMap("bench3d_m1", "xyz", array(v3d_med, c(30, 30, 30)), interpolate=F);
    map3d_m2 = p1.defineSpatialMap("bench3d_m2", "xyz", array(v3d_med, c(30, 30, 30)), interpolate=F);

    t1 = clock("mono");
    for (i in 1:ITERS) {
        map3d_m1.changeValues(array(v3d_med, c(30, 30, 30)));
        map3d_m1.smooth(0.12, "n", 0.04);
    }
    t2 = clock("mono");
    smooth_3d_med = (t2 - t1) / ITERS * 1000;

    t3 = clock("mono");
    for (i in 1:ITERS) {
        map3d_m2.changeValues(array(v3d_med, c(30, 30, 30)));
        map3d_m2.smooth_fast(0.12, "n", 0.04);
    }
    t4 = clock("mono");
    smooth_fast_3d_med = (t4 - t3) / ITERS * 1000;

    catn("  30x30x30: smooth=" + format("%.3f", smooth_3d_med) + "ms, smooth_fast=" + format("%.3f", smooth_fast_3d_med) + "ms, speedup=" + format("%.2f", smooth_3d_med/smooth_fast_3d_med) + "x");

    //
    // Different kernel types (2D 100x100)
    //
    catn("\n--- Kernel Types (2D 100x100) ---");

    kernels = c("f", "l", "e", "n", "c");
    kernelNames = c("flat", "linear", "exp", "normal", "cauchy");

    for (k in 0:(length(kernels)-1)) {
        ktype = kernels[k];
        kname = kernelNames[k];

        map_k1 = p1.defineSpatialMap("bench_k1_" + kname, "xy", matrix(v2d_med, 100, 100), interpolate=F);
        map_k2 = p1.defineSpatialMap("bench_k2_" + kname, "xy", matrix(v2d_med, 100, 100), interpolate=F);

        if (ktype == "e") {
            t1 = clock("mono");
            for (i in 1:ITERS) {
                map_k1.changeValues(matrix(v2d_med, 100, 100));
                map_k1.smooth(0.1, ktype, 10.0);
            }
            t2 = clock("mono");

            t3 = clock("mono");
            for (i in 1:ITERS) {
                map_k2.changeValues(matrix(v2d_med, 100, 100));
                map_k2.smooth_fast(0.1, ktype, 10.0);
            }
            t4 = clock("mono");
        } else if (ktype == "f" | ktype == "l") {
            t1 = clock("mono");
            for (i in 1:ITERS) {
                map_k1.changeValues(matrix(v2d_med, 100, 100));
                map_k1.smooth(0.1, ktype);
            }
            t2 = clock("mono");

            t3 = clock("mono");
            for (i in 1:ITERS) {
                map_k2.changeValues(matrix(v2d_med, 100, 100));
                map_k2.smooth_fast(0.1, ktype);
            }
            t4 = clock("mono");
        } else {
            t1 = clock("mono");
            for (i in 1:ITERS) {
                map_k1.changeValues(matrix(v2d_med, 100, 100));
                map_k1.smooth(0.1, ktype, 0.025);
            }
            t2 = clock("mono");

            t3 = clock("mono");
            for (i in 1:ITERS) {
                map_k2.changeValues(matrix(v2d_med, 100, 100));
                map_k2.smooth_fast(0.1, ktype, 0.025);
            }
            t4 = clock("mono");
        }

        smooth_k = (t2 - t1) / ITERS * 1000;
        smooth_fast_k = (t4 - t3) / ITERS * 1000;

        catn("  " + kname + ": smooth=" + format("%.3f", smooth_k) + "ms, smooth_fast=" + format("%.3f", smooth_fast_k) + "ms, speedup=" + format("%.2f", smooth_k/smooth_fast_k) + "x");
    }

    catn("\n===========================================");
    catn("Benchmark complete.");
    catn("===========================================");

    sim.simulationFinished();
}
